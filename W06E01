/*
 * File:   main.c
 * Author: Kari Turtiainen kpturt@utu.fi
 *
 * Created on December 5, 2021, 8:49 PM
 * 
 * Sends numbers to seven segment from terminal
 */

#include <xc.h>
#include <avr/io.h>
#include "FreeRTOS.h"
#include "clock_config.h"
#include "task.h"
#include "queue.h"
#include <string.h> 

#define BLINK_DELAY    250                       // milliseconds
#define USART0_BAUD_RATE(BAUD_RATE) \
((float)(3333333 * 64 / (16 * (float)BAUD_RATE)) + 0.5) //from USART guide

// 7-segment values from 0 to 9 in an array + first one being "empty"
uint8_t seven_segment_numbers[] =
{   
    0b00111111, // 0
    0b00000110,
    0b01011011,
    0b01001111,
    0b01100110,
    0b01101101,
    0b01111101,
    0b00000111,
    0b01111111,
    0b01100111, // 9
    0b01111001, // E
    0b00000000, // empty
};

static QueueHandle_t xQueue_number, xQueue_message; // Initialize queues


// Task function to display numbers on the seven segment display
void seven_segment(void* parameter)
{
    PORTC.DIRSET = 0xFF; // Sets PORTC (LED display) ports as outputs (1)
    
    PORTF.DIRSET = PIN5_bm; // Drive PF5 (Transistor) as output (1)
    PORTF.OUTSET = PIN5_bm; // and drive display to ground
    
    uint8_t seven_segment_index = 11; // Initialize index to show nothing
    char message;
    
    
    // This task will run indefinitely
    for (;;)
    {
        if( xQueueReceive( xQueue_number, (void*) & message, 0) == pdTRUE )
        {
                if(message == '0')
            {
                seven_segment_index = 0;
            }
            else if(message == '1')
            {
                seven_segment_index = 1;
            }
            else if(message == '2')
            {
                seven_segment_index = 2;
            }
            else if(message == '3')
            {
                seven_segment_index = 3;
            }
            else if(message == '4')
            {
                seven_segment_index = 4;
            }
            else if(message == '5')
            {
                seven_segment_index = 5;
            }
            else if(message == '6')
            {
                seven_segment_index = 6;
            }
            else if(message == '7')
            {
                seven_segment_index = 7;
            }
            else if(message == '8')
            {
                seven_segment_index = 8;
            }
            else if(message == '9')
            {
                seven_segment_index = 9;
            }
            else
            {
                seven_segment_index = 10; //displays E
            }
            // Sets the index number to seven segment
            PORTC.OUT = seven_segment_numbers[seven_segment_index];
        }
    }
    // Above loop will not end, but as a practice, tasks should always include
    // a vTaskDelete() call just-in-case
    vTaskDelete(NULL);
}

void create_queue(void){
    const uint8_t number_queue_length = 10; // Number queue length
    const uint8_t message_queue_length = 10; // Message queue length
    
    // Create queue for numbers
    xQueue_number = xQueueCreate(number_queue_length, sizeof(uint8_t));
    // Create queue for messages
    xQueue_message = xQueueCreate(message_queue_length, sizeof(uint8_t));
}

//-----------------------------------------------------------------
// Function to initialize USART0, from Microship USART guide
void USART0_init(void){
    PORTA.DIRSET = PIN0_bm; // Set PA0 as output (1)
    PORTA.DIRCLR = PIN1_bm; // Set PA1 as input (0)
    // For setting baud to 9600
    USART0.BAUD = (uint16_t)USART0_BAUD_RATE(9600);
    // For setting transmitter and receiver
    USART0.CTRLB |= USART_RXEN_bm | USART_TXEN_bm;
}
// Function to send chars to terminal, from Microship USART guide
void USART0_sendChar(char c)
{
    while (!(USART0.STATUS & USART_DREIF_bm))
    {
        ;
    }        
    USART0.TXDATAL = c;
}
// Function to send strings to terminal, from Microship USART guide
void USART0_sendString(char *str)
{
    for(size_t i = 0; i < strlen(str); i++)
    {
        USART0_sendChar(str[i]);
    }
}
// Function to read terminal, from Microship USART guide
uint8_t USART0_read()
{
    while (!(USART0.STATUS & USART_RXCIF_bm))
    {
        ;
    }
    return USART0.RXDATAL;
}
//-----------------------------------------------------------------



// Function to send to terminal
void send_message(void* parameter)
{
    char received_message; // Char to save received message
    
    // This task will run indefinitely
    for(;;)
    {  
        // This checks if there are messages in que
        if (xQueueReceive(xQueue_message, (void *)&received_message, 0) == pdTRUE) 
        {
            // Here we check if the given input is valid (number or not)
            if(received_message >= '0' && received_message <= '9')
            {
                // If number
                USART0_sendString("Valid digit!\r\n");
            }
            else
            { 
                // If not a number
                USART0_sendString("Error! Not a valid digit\r\n");
            }
        }
    }
    // Above loop will not end, but as a practice, tasks should always include
    // a vTaskDelete() call just-in-case
    vTaskDelete(NULL);
}

// Function to read from terminal
void receive_message(void* parameter)
{   
    char received_char; // Char to save received char
    // This task will run indefinitely
    for(;;)
    {
        received_char = USART0_read(); // Read and write received char
        // Send char to number que
        xQueueSend(xQueue_number, (void *)&received_char, 10);
        // Send char to message que
        xQueueSend(xQueue_message, (void *)&received_char, 10);
    }
    // Above loop will not end, but as a practice, tasks should always include
    // a vTaskDelete() call just-in-case
    vTaskDelete(NULL);
}


int main(void)
{
    create_queue(); // Create queue
    USART0_init(); // Initialize USART0
    
    // Create a task for seven segment display
    xTaskCreate(
        seven_segment,
        "segment",
        configMINIMAL_STACK_SIZE,
        NULL,
        tskIDLE_PRIORITY,
        NULL
    );
    
    // Create a task for sending messages
    xTaskCreate(
        send_message,
        "send_msg",
        configMINIMAL_STACK_SIZE,
        NULL,
        tskIDLE_PRIORITY,
        NULL
    );
    
    // Create a task for receiving messages
    xTaskCreate(
        receive_message,
        "receive_msg",
        configMINIMAL_STACK_SIZE,
        NULL,
        tskIDLE_PRIORITY,
        NULL
    );
    

    // Start the scheduler
    vTaskStartScheduler();

    // Scheduler will not return
    return 0;
}
